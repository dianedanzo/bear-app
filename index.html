<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <title>Bear App</title>
  </head>
  <body>
    <div id="root"></div>
    <script>
  (function () {
    function getInitData() {
      try {
        return (window && window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData) || "";
      } catch (e) { return ""; }
    }
    function isApiUrl(input) {
      try {
        if (typeof input === "string") return input.startsWith("/api/");
        if (input instanceof URL) return input.pathname.startsWith("/api/");
        if (typeof Request !== "undefined" && input instanceof Request) {
          const u = new URL(input.url, location.href);
          return u.pathname.startsWith("/api/");
        }
      } catch (e) {}
      return false;
    }
    if (typeof window !== "undefined" && typeof window.fetch === "function") {
      const origFetch = window.fetch;
      window.fetch = function (input, init) {
        try {
          if (isApiUrl(input)) {
            const headers = new Headers((init && init.headers) || undefined);
            const initData = getInitData();
            if (initData && !headers.has("X-Init-Data")) headers.set("X-Init-Data", initData);
            if (init && init.body && !headers.has("content-type")) headers.set("content-type","application/json");

            if (typeof Request !== "undefined" && input instanceof Request) {
              const url = input.url;
              const newInit = {
                method: input.method,
                headers,
                body: input.body,
                mode: input.mode,
                credentials: input.credentials,
                cache: input.cache,
                redirect: input.redirect,
                referrer: input.referrer,
                referrerPolicy: input.referrerPolicy,
                integrity: input.integrity,
                keepalive: input.keepalive,
                signal: input.signal,
              };
              return origFetch(url, newInit);
            }
            const newInit = Object.assign({}, init || {}, { headers });
            return origFetch(input, newInit);
          }
        } catch (e) {}
        return origFetch(input, init);
      };
    }
  })();
</script>
<style>
  #__dbgbtn {
    position: fixed; right: 12px; bottom: 12px; z-index: 999999;
    padding: 10px 14px; border-radius: 10px; border: 1px solid #aaa;
    background: #fff; color: #222; font-weight: 700; font-family: sans-serif;
    box-shadow: 0 2px 10px rgba(0,0,0,.15); cursor: pointer;
  }
</style>

<script>
  // tombol kecil untuk test API dari dalam Mini App
  (function(){
    function addBtn(){
      if (document.getElementById("__dbgbtn")) return;
      var b = document.createElement("button");
      b.id="__dbgbtn"; b.textContent="Debug API";
      b.onclick = async function(){
        try{
          var tg = (window.Telegram && Telegram.WebApp) || {};
          var info = {
            hasTelegram: !!window.Telegram,
            hasWebApp: !!tg,
            initDataLength: (tg.initData || "").length,
            initDataPreview: (tg.initData || "").slice(0,60)
          };
          var echo = await fetch("/api/debug/echo").then(r=>r.json()).catch(e=>({error:String(e)}));
          var who  = await fetch("/api/debug/whoami").then(r=>r.json()).catch(e=>({error:String(e)}));
          alert(JSON.stringify({info, echo, who}, null, 2));
        }catch(e){ alert("ERR "+e); }
      };
      document.body.appendChild(b);
    }
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", addBtn);
    } else { addBtn(); }
  })();
</script>
    
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
